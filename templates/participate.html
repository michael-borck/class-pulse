{% extends "layout.html" %}

{% block title %}Participate - ClassPulse{% endblock %}

{% block head %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Tailwind CSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- Socket.IO client library - Use the latest version to ensure compatibility -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<!-- jQuery for easier DOM manipulation -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // Add this immediately to check browser console
  console.log('Participate view loading...');
</script>
{% endblock %}

{% block content %}
<section class="audience-view">
    <div class="mb-4 flex justify-between items-center">
        <div>
            <h2 class="text-xl font-semibold">Session: {{ presentation_session.title }}</h2>
            <span class="text-sm text-gray-600">Code: <span class="font-mono font-bold">{{ presentation_session.code }}</span></span>
        </div>
        <span id="connection-status" class="connection-status disconnected">Connecting...</span>
    </div>

    <div id="waiting-message" class="waiting-message" style="display: {% if active_question %}none{% else %}block{% endif %};">
        <i class="fa fa-spin fa-circle-notch text-4xl text-gray-400 mb-4"></i>
        <p>Waiting for the presenter to activate a question...</p>
    </div>

    <div id="question-container" class="question-container" style="display: {% if active_question %}block{% else %}none{% endif %};">
        <h3 id="question-text" class="question-title">{% if active_question %}{{ active_question.text }}{% endif %}</h3>

        <!-- Multiple Choice Question -->
        <div id="multiple-choice-container" class="question-type-container" style="display: {% if active_question and active_question.type == 'multiple_choice' %}block{% else %}none{% endif %};">
            <form id="multiple-choice-form" action="javascript:void(0);">
                <div class="options-container">
                    <!-- Options will be added dynamically -->
                    {% if active_question and active_question.type == 'multiple_choice' and active_question.options_list %}
                        {% for option in active_question.options_list %}
                        <label class="option-item">
                            <input type="radio" name="mc-option" value="{{ option }}" required>
                            <span>{{ option }}</span>
                        </label>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-medium py-2 rounded hover:bg-blue-600">Submit</button>
            </form>
        </div>

        <!-- Word Cloud Question -->
        <div id="word-cloud-container" class="question-type-container" style="display: none;">
            <form id="word-cloud-form">
                <input type="text" maxlength="30" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200 mb-2" placeholder="Enter your word or short phrase..." required>
                <button type="submit" class="w-full bg-purple-500 text-white font-medium py-2 rounded hover:bg-purple-600">Submit</button>
            </form>
        </div>

        <!-- Rating Scale Question -->
        <div id="rating-scale-container" class="question-type-container" style="display: none;">
            <form id="rating-scale-form">
                <div class="mb-2 font-medium">Your rating: <span class="ml-2 text-lg font-bold rating-value">3</span></div>
                <input type="range" min="1" max="5" value="3" class="w-full mb-2" oninput="document.querySelector('.rating-value').textContent=this.value;">
                <div class="flex justify-between text-xs text-gray-400 mb-1 px-1">
                    <span>Poor</span><span>Excellent</span>
                </div>
                <button type="submit" class="w-full bg-yellow-500 text-white font-medium py-2 rounded hover:bg-yellow-600">Submit</button>
            </form>
        </div>

        <!-- Response Confirmation -->
        <div id="response-confirmation" class="answer-confirmation" style="display: none;">
            <i class="fa fa-check-circle success-icon"></i>
            <h3 class="text-xl font-bold mb-2">Response Submitted!</h3>
            <p class="text-gray-600">Your response has been recorded.</p>
            <p class="text-sm text-gray-500 mt-4">Waiting for the next question...</p>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
	<script>
	    // Set up necessary session variables
	    window.sessionId = {{ presentation_session.id }};
	    window.sessionCode = "{{ presentation_session.code }}";
	    window.participantId = "{{ session.get('participant_id', '') }}";
	    window.activeQuestion = null; // Initialize global activeQuestion

	    // If there's an active question, make it available to the JS
	    {% if active_question_js %}
	    window.activeQuestion = {{ active_question_js|safe }};
	    console.log('Initial active question (JSON):', window.activeQuestion);

	    // Immediately update the UI to show we have an active question
	    document.addEventListener('DOMContentLoaded', function() {
	          const waitingMessage = document.getElementById('waiting-message');
	          const questionContainer = document.getElementById('question-container');

	          if (waitingMessage) waitingMessage.style.display = 'none';
	          if (questionContainer) questionContainer.style.display = 'block';
	      });
	      {% else %}
	      console.log('No active question available');
	      {% endif %}

	    // Load audience.js with all the Socket.IO event handling (with cache-busting)
	    document.addEventListener('DOMContentLoaded', function() {
	        console.log('Participate page loaded, sessionId:', sessionId, 'sessionCode:', sessionCode);

	        const script = document.createElement('script');
	        script.src = "{{ url_for('static', filename='js/audience.js') }}?_timestamp=" + new Date().getTime();
	        document.body.appendChild(script);

	        // Force refresh the page on F5 or refresh button
	        const originalReload = window.onbeforeunload;
	        window.onbeforeunload = function(e) {
	            if (originalReload) originalReload(e);
	            // Clear any cached data
	            localStorage.removeItem('audience_cache');
	            sessionStorage.clear();
	        };
	    });
	</script>
{% endblock %}